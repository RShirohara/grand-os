ARG BUILDER_VERSION=43
ARG REPOSITORY_COMMIT_HASH=60e7f1b4c26cde034049d0da89d415218f479314

# stage 1: build theme.
FROM registry.fedoraproject.org/fedora-minimal:${BUILDER_VERSION} AS builder
ARG REPOSITORY_COMMIT_HASH

# hadolint ignore=DL3041
RUN dnf --setopt="install_weak_deps=False" install --assumeyes \
      file \
      gdm \
      git \
      glib2-devel \
      ImageMagick \
      sassc \
      sudo \
      which \
    && dnf clean all

WORKDIR /WhiteSur-gtk-theme
RUN git init \
    && git remote add origin https://github.com/vinceliuice/WhiteSur-gtk-theme \
    && git fetch origin "${REPOSITORY_COMMIT_HASH}" --depth=1 \
    && git checkout FETCH_HEAD

WORKDIR /WhiteSur-gtk-theme
# Install theme.
RUN --mount=type=bind,source=./scripts,target=/WhiteSur-gtk-theme/scripts,rw \
    USER=root ./install.sh \
      --dest /usr/share/themes \
      --color "dark" \
      --opacity "normal" \
      --shell \
      -i "fedora" \
      --silent-mode \
# Install libadwiata theme.
    && ./scripts/install-libadwaita.sh \
# Install GDM theme.
    && USER=root ./tweaks.sh \
      --color "dark" \
      --gdm \
      -i "fedora" \
      -background "blank" \
      --silent-mode

# stage 2: copy theme to distribution container.
FROM scratch AS dist

COPY --from=builder \
    /usr/share/themes/WhiteSur-Dark \
    /usr/share/themes/WhiteSur-Dark
COPY --from=builder \
    /usr/share/gnome-shell/gnome-shell-theme.gresource \
    /usr/share/themes/WhiteSur-Extension/gdm/gnome-shell-theme.gresource
